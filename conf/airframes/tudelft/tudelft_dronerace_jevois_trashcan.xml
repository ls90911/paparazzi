<!DOCTYPE airframe SYSTEM "../airframe.dtd">
<airframe name="Trashcan">
    <description>
* Airframe for the regular "Trashcan" Quadrotor frame equipped with to validate all onboard functionally.
     + Autopilot:   Default Crazybee F4 Pro STM32F4 and all that comes with it
     + Actuators:   Default onboard Blheli S ESCs see http://wiki.paparazziuav.org/wiki/Subsystem/actuators#PWM
     + Telemetry:   Default WiFi  Via ESP8266 see

  NOTES:
     + All set to expect flying on 2s LiPo battery, 1s LiPo battery possible but no gains set (yet..)
     + Removed Camera and Video TX to be replaced by a JeVois (www.jevois.org) camera on Uart1

  WIP:
     + Vison: added a JeVois on UART1 TX/RX
     + RC RX:       OpenRX FrSky compatible over air 2.4Ghz CPPM out, now temporary via wifi telemetry module
     + GPS:         uBlox SAM M8Q with Magneto n Baro GNSS
    </description>

    <firmware name="rotorcraft">
        <target name="ap" board="crazybee_f4_1.0">
            <define name="AUTOPILOT_DISABLE_AHRS_KILL"/> <!--  Starts in KILL, but can now switch to NAV -->

            <!-- Towards a better and no messing it all up kind of aligner when wobbly plugging in battery ;) -->
            <!--
            <define name="AHRS_ALIGNER_SAMPLES_NB" value="200"/>
            <define name="LOW_NOISE_THRESHOLD" value="30000"/>
            <define name="LOW_NOISE_TIME" value="10"/>
            -->

<!-- 512 Hz -->
<!--
            <configure name="PERIODIC_FREQUENCY" value="512"/>
            <define name="IMU_MPU_LOWPASS_FILTER" value="MPU60X0_DLPF_256HZ"/>
            <define name="IMU_MPU_SMPLRT_DIV" value="3"/>-->

<!-- see e.g. https://github.com/kriswiner/MPU9250/issues/59 -->
<!-- 1 kHz -->
<!-- NOT TESTED IMU_MPU_LOWPASS_FILTER and IMU_MPU_SMPLRT_DIV  TODO - ATM likely INCORRECT values-->
        <!--in Freq in HZ
            <configure name="PERIODIC_FREQUENCY" value="1024"/>

            <define name="HFF_PRESCALER" value="20" />
            <define name="AHRS_PROPAGATE_FREQUENCY" value="1000"/>
            <configure name="AHRS_CORRECT_FREQUENCY" value="1000"/>
            <configure name="AHRS_MAG_CORRECT_FREQUENCY" value="50"/>

            <define name="IMU_MPU_LOWPASS_FILTER" value="MPU60X0_DLPF_256HZ"/>
            <define name="IMU_MPU_SMPLRT_DIV" value="3"/>

            <configure name="NAVIGATION_FREQUENCY" value="16"/>
            <configure name="CONTROL_FREQUENCY" value="120"/>
            <configure name="TELEMETRY_FREQUENCY" value="60"/>
            <configure name="MODULES_FREQUENCY" value="1024"/>
         -->

<!-- 2 kHz -->
<!-- NOT TESTED IMU_MPU_LOWPASS_FILTER and IMU_MPU_SMPLRT_DIV  TODO - ATM likely INCORRECT values-->
<!--
            <configure name="PERIODIC_FREQUENCY" value="2048"/>

            <define name="HFF_PRESCALER" value="40" />
            <define name="AHRS_PROPAGATE_FREQUENCY" value="1000"/>
            <configure name="AHRS_CORRECT_FREQUENCY" value="1000"/>
            <configure name="AHRS_MAG_CORRECT_FREQUENCY" value="100"/>

            <define name="IMU_MPU_LOWPASS_FILTER" value="MPU60X0_DLPF_256HZ"/>
            <define name="IMU_MPU_SMPLRT_DIV" value="3"/>

            <configure name="NAVIGATION_FREQUENCY" value="16"/>
            <configure name="CONTROL_FREQUENCY" value="240"/>
            <configure name="TELEMETRY_FREQUENCY" value="60"/>
            <configure name="MODULES_FREQUENCY" value="2048"/>
-->
            <!--define name="USE_PERSISTENT_SETTINGS" value="TRUE"/--> <!--  No Errors, not tested if it works we have 16kb-->
            <define name="BAT_CHECKER_DELAY" value="50"/> <!-- amount of time it take for the bat to be checked  -->
            <!-- to avoid bat low spike detection when strong up movement withch draws short sudden power-->
            <define name="CATASTROPHIC_BATTERY_KILL_DELAY" value="50"/><!-- in seconds-->
        </target>

        <module name="radio_control" type="datalink"> <!--datalink(e.g. wifi) or ppm  or sbus-->
            <!--<define name="SBUS_PORT" value="UART1"/>-->
            <!-- <define name="RADIO_CONTROL_NB_CHANNEL" value="8"/>-->

            <!-- for debugging PPM value the one below -->
            <!--<define name="TELEMETRY_MODE_FBW" value="1"/>-->

            <!-- <define name="RADIO_MODE" value="RADIO_FLAP"/> -->
            <!-- <define name="RADIO_KILL_SWITCH" value="RADIO_GEAR"/>-->
        </module>

        <module name="motor_mixing"/>

        <module name="actuators" type="pwm">
            <define name="SERVO_HZ" value="400"/>
        </module>

        <!-- <module name="telemetry" type="transparent_usb"/>--><!-- Not working, maybe broken in LibopenCM3 ATM? -->

        <module name="imu" type="mpu6000">
            <configure name="IMU_MPU_SPI_DEV" value="spi1"/>
            <configure name="IMU_MPU_SPI_SLAVE_IDX" value="SPI_SLAVE0"/>

            <!-- define name="ICM20608"/> --> <!-- Not used atm -->
            <!-- To be able (for now) to set AP IMU orientaion -->
            <define name="IMU_GYRO_P_SIGN" value="-1"/>
            <define name="IMU_GYRO_Q_SIGN" value="1"/>
            <define name="IMU_GYRO_R_SIGN" value="-1"/>
            <define name="IMU_ACCEL_X_SIGN" value="-1"/>
            <define name="IMU_ACCEL_Y_SIGN" value="1"/>
            <define name="IMU_ACCEL_Z_SIGN" value="-1"/>
        </module>

        <module name="ins" type="extended"/> <!--TODO: change later to <module name="ins" type="gps_passthrough"/>-->

        <module name="ahrs" type="int_cmpl_quat">
            <configure name="USE_MAGNETOMETER" value="FALSE" />
            <define name="AHRS_USE_GPS_HEADING" value="TRUE"/> <!-- true for Optitrac-->
            <define name="AHRS_GRAVITY_HEURISTIC_FACTOR" value="0"/> <!-- TODO: determine best... Default is 30. Reduce accelerometer cut-off frequency when the vehicle is accelerating: norm(ax,ay,az) 9,81 m/s2. WARNING: when the IMU is not well damped, the norm of accelerometers never equals to 9,81 m/s2. As a result, the GRAVITY_HEURISTIC_FACTOR will reduce the accelerometer bandwith even if the vehicle is not accelerating. -->
            <!--<define name="AHRS_PROPAGATE_LOW_PASS_RATES" value="FALSE"/>--> <!-- apply a low pass filter on rotational velocity"-->
        </module>

        <module name="stabilization" type="int_quat"/>
        <!--module name="stabilization" type="rate_indi"/>
        <module name="stabilization" type="indi_simple" /-->

        <!-- <module name="stabilization" type="indi"/> -->

        <module name="telemetry" type="transparent">
            <configure name="MODEM_PORT" value="UART2"/>
            <configure name="MODEM_BAUD" value="B115200"/>
        </module>

        <!--module name="guidance" type="indi">
            <define name="GUIDANCE_INDI_SPECIFIC_FORCE_GAIN" value="-500.0"/>
        </module-->

        <!--module name="ctrl_module_outerloop_demo"/-->
        <module name="dronerace"/>
        <module name="jevois_mavlink">
            <configure name="JEVOIS_UART" value="UART1"/>
            <configure name="JEVOIS_BAUD" value="B115200"/>
        </module>
        <module name="gps" type="datalink"/>
        <!-- No I2C yet... need to find some good spot for I2C pins -->
        <!--
        <module name="gps" type="ublox">
        <configure name="GPS_PORT" value="I2C"/>
        </module>
        -->

        <!-- <module name="geo_mag"/> -->
        <module name="air_data"/>

        <!-- below temporary until tested then remove it -->
        <!-- <module name="send_imu_mag_current"/> -->

<!--
        <target name="nps" board="pc">
            <module name="fdm" type="jsbsim"/>
            <module name="radio_control" type="ppm">
                <define name="RADIO_CONTROL_NB_CHANNEL" value="8"/>
            </module>
        </target>
-->
        <target name="FPV Racing" board="crazybee_f4_1.0">
            <!--

            WIP
              For FPV setup only
              No GPS
              No Baro
              No Magneto
              Highest loop rate
              Flip module
              Mavlink module for OSD

            -->
                  <!-- 2 kHz -->
            <!--
                  <define name="HFF_PRESCALER" value="40" />
                  <configure name="PERIODIC_FREQUENCY" value="2048"/>
                  <define name="AHRS_PROPAGATE_FREQUENCY" value="2000"/>
            -->
                <!-- <module name="stabilization" type="rate"/> -->
                <!-- <module name="stabilization" type="indi_simple" /> -->
                <!-- <module name="stabilization" type="indi" /> -->
        </target>

    </firmware>

    <servos driver="Pwm">
        <servo name="FL" no="3" min="1000" neutral="1030" max="2000"/>
        <servo name="FR" no="1" min="1000" neutral="1030" max="2000"/>
        <servo name="BR" no="0" min="1000" neutral="1030" max="2000"/>
        <servo name="BL" no="2" min="1000" neutral="1030" max="2000"/>
    </servos>

    <commands>
        <axis name="ROLL"   failsafe_value="0"/>
        <axis name="PITCH"  failsafe_value="0"/>
        <axis name="YAW"    failsafe_value="0"/>
        <axis name="THRUST" failsafe_value="0"/>
    </commands>

    <section name="MIXING" prefix="MOTOR_MIXING_">
        <define name="REVERSE" value="TRUE"/>
        <define name="TYPE" value="QUAD_X"/>
    </section>

  <!--section name="MIXING" prefix="MOTOR_MIXING_">
    <define name="TRIM_ROLL" value="0"/>
    <define name="TRIM_PITCH" value="0"/>
    <define name="TRIM_YAW" value="0"/>
    <define name="NB_MOTOR" value="4"/>
    <define name="SCALE" value="256"/>
    <define name="ROLL_COEF" value="{  -256, -256,  256,  256 }"/>
    <define name="PITCH_COEF" value="{  256, -256, -256,  256 }"/>
    <define name="YAW_COEF" value="{    256, -256,  256, -256 }"/>
    <define name="THRUST_COEF" value="{ 256,  256,  256,  256 }"/>
  </section-->

    <command_laws>
        <call fun="motor_mixing_run(autopilot_get_motors_on(),FALSE,values)"/>
        <set servo="FL" value="motor_mixing.commands[MOTOR_FRONT_LEFT]"/>
        <set servo="FR" value="motor_mixing.commands[MOTOR_FRONT_RIGHT]"/>
        <set servo="BR" value="motor_mixing.commands[MOTOR_BACK_RIGHT]"/>
        <set servo="BL" value="motor_mixing.commands[MOTOR_BACK_LEFT]"/>
    </command_laws>

    <section name="IMU" prefix="IMU_">

        <define name="BODY_TO_IMU_PHI"   value="0." unit="deg"/>
        <define name="BODY_TO_IMU_THETA" value="0." unit="deg"/>
        <define name="BODY_TO_IMU_PSI"   value="270." unit="deg"/>

        <define name="MAG_X_SIGN" value="1"/>
        <define name="MAG_Y_SIGN" value="1"/>
        <define name="MAG_Z_SIGN" value="1"/>

        <!-- replace this with your own calibration -->
        <define name="ACCEL_X_NEUTRAL" value="0"/>
        <define name="ACCEL_Y_NEUTRAL" value="0"/>
        <define name="ACCEL_Z_NEUTRAL" value="0"/>

        <!-- replace this with your own calibration -->
        <define name="MAG_X_NEUTRAL" value="0"/>
        <define name="MAG_Y_NEUTRAL" value="0"/>
        <define name="MAG_Z_NEUTRAL" value="0"/>
        <define name="MAG_X_SENS" value="8.0" integer="16"/>
        <define name="MAG_Y_SENS" value="8.0" integer="16"/>
        <define name="MAG_Z_SENS" value="8.0" integer="16"/>

    </section>

    <section name="STABILIZATION_ATTITUDE" prefix="STABILIZATION_ATTITUDE_">
        <!-- setpoints -->
        <define name="SP_MAX_PHI"     value="60." unit="deg"/>
        <define name="SP_MAX_THETA"   value="60." unit="deg"/>
        <define name="SP_MAX_R"       value="120." unit="deg/s"/>
        <define name="DEADBAND_A"     value="0"/>
        <define name="DEADBAND_E"     value="0"/>
        <define name="DEADBAND_R"     value="100"/>

        <!-- reference -->
        <define name="REF_OMEGA_P"  value="800" unit="deg/s"/>
        <define name="REF_ZETA_P"   value="0.85"/>
        <define name="REF_MAX_P"    value="400." unit="deg/s"/>
        <define name="REF_MAX_PDOT" value="RadOfDeg(8000.)"/>

        <define name="REF_OMEGA_Q"  value="800" unit="deg/s"/>
        <define name="REF_ZETA_Q"   value="0.85"/>
        <define name="REF_MAX_Q"    value="400." unit="deg/s"/>
        <define name="REF_MAX_QDOT" value="RadOfDeg(8000.)"/>

        <define name="REF_OMEGA_R"  value="500" unit="deg/s"/>
        <define name="REF_ZETA_R"   value="0.85"/>
        <define name="REF_MAX_R"    value="180." unit="deg/s"/>
        <define name="REF_MAX_RDOT" value="RadOfDeg(1800.)"/>

        <!-- feedback -->
        <define name="PHI_PGAIN"  value="90"/>
        <define name="PHI_DGAIN"  value="92"/>
        <define name="PHI_IGAIN"  value="26"/>

        <define name="THETA_PGAIN"  value="90"/>
        <define name="THETA_DGAIN"  value="92"/>
        <define name="THETA_IGAIN"  value="22"/>

        <define name="PSI_PGAIN"  value="400"/>
        <define name="PSI_DGAIN"  value="200"/>
        <define name="PSI_IGAIN"  value="5"/>

        <!-- feedforward -->
        <define name="PHI_DDGAIN"   value="0"/>
        <define name="THETA_DDGAIN" value="0"/>
        <define name="PSI_DDGAIN"   value="0"/>
    </section>

    <section name="STABILIZATION_ATTITUDE_INDI" prefix="STABILIZATION_INDI_">
        <!-- control effectiveness -->
        <define name="G1_P" value="0.035" />
        <define name="G1_Q" value="0.035" />
        <define name="G1_R" value="0.0022" />
        <define name="G2_R" value="0.10" />

        <!-- For some airframes, e.g. Bebop2 we need to filter the roll rate due to the dampers -->
        <define name="FILTER_ROLL_RATE" value="FALSE" />
        <define name="FILTER_PITCH_RATE" value="FALSE" />
        <define name="FILTER_YAW_RATE" value="FALSE" />

        <!-- reference acceleration for attitude control -->
        <define name="REF_ERR_P" value="600.0" />
        <define name="REF_ERR_Q" value="600.0" />
        <define name="REF_ERR_R" value="600.0" />
        <define name="REF_RATE_P" value="30.0" />
        <define name="REF_RATE_Q" value="30.0" />
        <define name="REF_RATE_R" value="20.0" />

        <!-- second order filter parameters -->
        <define name="FILT_OMEGA" value="50.0"/>
        <define name="FILT_ZETA" value="0.55"/>
        <define name="FILT_OMEGA_R" value="50.0"/>
        <define name="FILT_ZETA_R" value="0.55"/>

        <!-- second order filter parameters -->
        <define name="FILT_CUTOFF" value="8.0"/>
        <define name="FILT_CUTOFF_R" value="3.2"/>

        <!-- first order actuator dynamics (indi_simple) -->
        <define name="ACT_DYN_P" value="0.10" />
        <define name="ACT_DYN_Q" value="0.10" />
        <define name="ACT_DYN_R" value="0.10" />

        <!-- Adaptive Learning Rate -->
        <define name="USE_ADAPTIVE" value="FALSE" />
        <define name="ADAPTIVE_MU" value="0.0003" />

        <!--Maxium yaw rate, to avoid instability -->
        <define name="MAX_R" value="80" unit="deg/s" />
    </section>

    <section name="GUIDANCE_V" prefix="GUIDANCE_V_">
        <define name="HOVER_KP"    value="150"/>
        <define name="HOVER_KD"    value="80"/>
        <define name="HOVER_KI"    value="20"/>
        <define name="NOMINAL_HOVER_THROTTLE" value="0.33"/>
        <define name="ADAPT_THROTTLE_ENABLED" value="FALSE"/>
    </section>

    <section name="INS" prefix="INS_">
    <!-- Use GPS altitude measurments and set the R gain -->
    <define name="USE_GPS_ALT" value="1"/>
    <define name="VFF_R_GPS" value="0.01"/>
    </section>

    <section name="AHRS" prefix="AHRS_">
         <define name="H_X" value=" 0.51562740288882"/>
         <define name="H_Y" value="-0.05707735220832"/>
         <define name="H_Z" value=" 0.85490967783446"/>

         <define name="HEADING_UPDATE_GPS_MIN_SPEED" value="0"/>
    </section>

    <section name="GUIDANCE_H" prefix="GUIDANCE_H_">
        <define name="MAX_BANK" value="30." unit="deg"/>
        <define name="USE_SPEED_REF" value="TRUE"/>
        <define name="PGAIN" value="50"/>
        <define name="DGAIN" value="100"/>
        <define name="AGAIN" value="70"/>
        <define name="IGAIN" value="20"/>
    </section>

<!-- ********************** AP ************************** -->
    <section name="AUTOPILOT">
        <define name="MODE_MANUAL" value="AP_MODE_ATTITUDE_DIRECT"/><!-- for now...-->
        <define name="MODE_AUTO1"  value="AP_MODE_HOVER_Z_HOLD"/><!-- for now...-->
        <define name="MODE_AUTO2"  value="AP_MODE_HOVER_Z_HOLD"/><!-- for now...-->
        <define name="USE_THROTTLE_FOR_MOTOR_ARMING" value="TRUE"/>
        <define name="NO_RC_THRUST_LIMIT" value="TRUE"/>
    </section>

    <!-- If flying on a 2S1P 300mAh 40/80C LiPo -->
    <section name="BAT">
        <define name="MAX_BAT_CAPACITY" value="300" unit="mAh"/>
        <!-- tested at V 7.6 the avg -->  <!-- idle RPM then ?A half throttle ?A-->
        <define name="MILLIAMP_AT_IDLE_THROTTLE" value="10" unit="mA"/>  <!-- TODO ??mA, with additional RC receiver ~??mA -->
        <define name="MILLIAMP_AT_FULL_THROTTLE" value="40" unit="mA"/> <!-- TODO At 7.2 ?? A at 8.2v ??A rounded then to ?? to be at safe side-->
        <define name="CATASTROPHIC_BAT_LEVEL" value="6.0" unit="V"/> <!-- TODO: test when AP board switches off -->
        <define name="CRITIC_BAT_LEVEL" value="6.6" unit="V"/>
        <define name="LOW_BAT_LEVEL" value="7.0" unit="V"/>
        <define name="MAX_BAT_LEVEL" value="8.4" unit="V"/>  <!-- 2s lipo 2x4.2 = 8.4 -->
    </section>

    <section name="SIMULATOR" prefix="NPS_">
        <define name="ACTUATOR_NAMES"  value="FL, FR, BR, BL" type="string[]"/>
        <define name="JSBSIM_MODEL" value="simple_quad" type="string"/>
        <define name="SENSORS_PARAMS" value="nps_sensors_params_default.h" type="string"/>
        <!-- mode switch on joystick channel 5 (axis numbering starting at zero) -->
        <!-- <define name="JS_AXIS_MODE" value="4"/>-->
    </section>

    <section name="GCS">
        <define name="SPEECH_NAME" value="Trashcan"/>
        <define name="AC_ICON" value="quadrotor_x"/>
        <define name="ALT_SHIFT_PLUS_PLUS" value="2"/> <!-- low diff for e.g. optitrack 10 for outside-->
        <define name="ALT_SHIFT_PLUS" value="1"/>
        <define name="ALT_SHIFT_MINUS" value="-1"/>
    </section>

</airframe>
